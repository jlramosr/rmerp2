<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="rmerp-styles.html">

<link rel="import" href="rmerp-view-template.html">

<dom-module id="rmerp-clients-list">
  <template>

    <style include="search-styles table-styles">
      :host {
        display: block;
      }
    </style>

    <rmerp-view-template>
      
      <iron-icon slot="toolbar-icon" icon="rmerp-icons:supervisor-account"></iron-icon>
      <span slot="toolbar-title">CLIENTES</span>

      <paper-icon-button class="toolbar-right-small-screen" on-tap="_newItemTapped" icon="rmerp-icons:add"></paper-icon-button>
      <div slot="toolbar-right">
        sasa
        <button on-tap="_newItemTapped">NUEVO CLIENTE</button>
      </div>

      <div slot="content">

        <div class="search">
          <input id="searchInput" class="search__input" on-keyup="_searchInputKeyup" placeholder="Buscar">
          <div class="search__results">[[_computedTotalResults(data)]]</div>
        </div>
        
        <iron-list id="ironList" items="[[data]]" max-physical-count="30">
          <template>
            <a class$="table__item [[_computeItemClass(index, data.length)]]" href="/clients/[[item.id]]/">
              <span class="table__item--primary-text">[[item.name]]</span>
              <span class="table__item--secondary-text">[[item.address]]</span>
            </a>
          </template>
        </iron-list>
      </div>

    </rmerp-view-template>

  </template>

  <script>

    class RMERPClientsList extends Polymer.Element {

      static get is() { 
        return 'rmerp-clients-list'; 
      }

      static get properties() {
        return {
          
          data: Array,

          _filteredData: Array,

          searchValue: String,

          loading: {
            type: Boolean,
            value: false
          }

        }
      }

      static get observers() {
        return [
          '_smallScreenChanged(smallScreen)'
        ];
      }

      _smallScreenChanged(smallScreen) {
        if (this._clientOverlay) {
          this._clientOverlay.smallScreen = smallScreen;
        }
      }

      _searchInputKeyup() {
        this.searchValue = this.$.searchInput.value.trim();
        this._updateFilteredData();
      }

      _updateFilteredData() {
        this._filteredData = [];
        if (this.searchValue && this.searchValue.length && this.loadComplete) {
          this._filteredData = fuzzaldrinPlus.filter(
            this.dataArray, this.searchValue, {key: 'name'});
        } else {
          this._filteredData = this.dataArray;
        } 
      }

      _computedTotalResults(_filteredData) {
        const length = _filteredData.length || '0';
        return length + ' results';
      }

      _newItemTapped() {
        if (this._clientOverlay) {
          return;
        }

        const overlay = document.createElement('rmerp-clients-new-overlay');
        overlay.open();

        this._clientOverlay = overlay;
        console.log(this, this._clientOverlay);
          /*opened: true,
          clients: this.data,
          smallScreen: this.smallScreen,
          onDetach: _ => {
            this._clientOverlay = null;
          }
        });*/
      }

      _editItemTapped(event) {
        console.log("HOLAAAAAAAAAAA");
        console.log(event.model.item);
      }

      _computeItemClass(index, itemsLength) {
        if (index == itemsLength - 1) {
          return 'table__item--last-child';
        }
      }
    }

    window.customElements.define(RMERPClientsList.is, RMERPClientsList);

  </script>
</dom-module>
