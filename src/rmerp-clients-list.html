<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="rmerp-styles.html">
<link rel="import" href="rmerp-icons.html">

<dom-module id="rmerp-clients-list">
  <template>

    <style include="header-layout-styles search-styles table-styles">
      :host {
        display: block;
      }
    </style>

    <div class="header-layout">

      <div class="header-layout__header">
        <div class="header-toolbar">

          <div class="header-toolbar__info">
            <iron-icon class="header-toolbar__icon" icon="rmerp-icons:supervisor-account"></iron-icon>
            <span class="header-toolbar__title">CLIENTES</iron-icon>
          </div>

          <div class="header-toolbar__actions">
            <template is="dom-if" if="[[smallScreen]]">
              <paper-icon-button on-tap="_newItemTapped" class="header-toolbar__icon" icon="add"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[!smallScreen]]">
              <button on-tap="_newItemTapped" class="header-toolbar__button">
                NUEVO CLIENTE
              </button>
            </template>
          </div>
        </div>
      </div>

      <div class="header-layout__content">

        <div class="search">
          <input id="searchInput" class="search__input" on-keyup="_searchInputKeyup" placeholder="Buscar">
          <div class="search__results">[[_computedTotalResults(_filteredData)]]</div>
        </div>

        <!--<iron-list id="ironList" items="[[_filteredData]]" max-physical-count="30">
          <template>
            <div class$="table__item [[_computeItemClass(index, data.length)]]" on-tap="_editItemTapped">
              <span class="table__item--primary-text">[[item.name]]</span>
              <span class="table__item--secondary-text">[[item.address]]</span>
            </div>
          </template>
        </iron-list>-->

      </div>

    </div>

  </template>

  <script>

    class RMERPClientsList extends Polymer.Element {

      static get is() { 
        return 'rmerp-clients-list'; 
      }

      static get properties() {
        return {
          data: Object,

          _filteredData: Array,

          searchValue: String,

          loadComplete: Boolean,

          loading: {
            type: Boolean,
            value: false
          }

        }
      }

      static get observers() {
        return [
          '_dataChanged(data, loadComplete)',
          '_smallScreenChanged(smallScreen)'
        ];
      }

      _dataChanged(data, loadComplete) {
        this.dataArray =  Object.keys(data).map(function(key) {
          return data[key];   
        });
        this._updateFilteredData();
      }

      _smallScreenChanged(smallScreen) {
        if (this._clientOverlay) {
          this._clientOverlay.smallScreen = smallScreen;
        }
      }

      _searchInputKeyup() {
        this.searchValue = this.$.searchInput.value.trim();
        this._updateFilteredData();
      }

      _updateFilteredData() {
        this._filteredData = [];
        if (this.searchValue && this.searchValue.length && this.loadComplete) {
          this._filteredData = fuzzaldrinPlus.filter(
            this.dataArray, this.searchValue, {key: 'name'});
        } else {
          this._filteredData = this.dataArray;
        }
      }

      _computedTotalResults(_filteredData) {
        const length = _filteredData.length || '0';
        return length + ' results';
      }

      _newItemTapped() {
        if (this._clientOverlay) {
          return;
        }

        this._clientOverlay = this.create('rmerp-clients-overlay', {
          opened: true,
          clients: this.data,
          smallScreen: this.smallScreen,
          onDetach: _ => {
            this._clientOverlay = null;
          }
        });
      }

      _editItemTapped(event) {
        if (this._clientOverlay) {
          return;
        }

        this._clientOverlay = this.create('rmerp-clients-overlay', {
          opened: true,
          readOnly: true,
          client: event.model.item,
          clients: this.data,
          smallScreen: this.smallScreen,
          onDetach: _ => {
            this._clientOverlay = null;
          }
        });
      }

      _computeItemClass(index, itemsLength) {
        if (index == itemsLength - 1) {
          return 'table__item--last-child';
        }
      }
    }

    window.customElements.define(RMERPClientsList.is, RMERPClientsList);

  </script>
</dom-module>
