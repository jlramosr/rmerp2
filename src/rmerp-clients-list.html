<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="rmerp-styles.html">
<link rel="import" href="rmerp-tmpl-header-layout.html">
<link rel="import" href="rmerp-button.html">

<dom-module id="rmerp-clients-list">
  <template>

    <style include="content-styles search-styles table-styles button-styles"></style>

    <rmerp-tmpl-header-layout
      title="CLIENTES"
      back-path="/dashboard"
      small-screen="{{smallScreen}}">

      <rmerp-button
        slot="action"
        title="NUEVO CLIENTE"
        icon="add"
        on-click="_newItemTapped"
        small="[[smallScreen]]"></rmerp-button>

      <div slot="content" class="content__list">

        <div class="search">
          <input id="searchInput" class="search__input" on-keyup="_searchInputKeyup" value="{{searchValue}}" placeholder="Buscar">
          <div class="search__results">[[_computedTotalResults(_filteredData)]]</div>
        </div>

        <iron-list id="ironList" items="[[_filteredData]]" max-physical-count="5">
          <template>
            <a class$="table__item [[_computeItemClass(index, _filteredData.length)]]" href="/clients/[[item.id]]">
              <div class="table__item__detail">
                <span class="table__item--primary-text">[[item.name]]</span>
                <span class="table__item--secondary-text">[[item.address]]</span>
              </div>
              <paper-icon-button
                id$="menuIcon-[[index]]"
                class="table__item--menu-icon"
                noink
                tabindex="-1"
                icon="rmerp-icons:more"
                on-click="_menuItemTapped"></paper-icon-button>
            </a>
          </template>
        </iron-list>

      </div>

    </rmerp-tmpl-header-layout>

    <!-- Lazy Creations -->
    <template is="dom-if" if="[[loadComplete]]">

      <rmerp-menu-dropdown
        actions="[[itemActions]]"
        collection="clients"></rmerp-menu-dropdown>

    </template>

  </template>

  <script>

    class RMERPClientsList extends Polymer.Element {

      static get is() {
        return 'rmerp-clients-list';
      }

      static get properties() {
        return {

          data: Array,

          itemActions: {
            type: Array,
            value: _ => {
              return [
                {name: 'overview', label: 'Vistazo', icon: 'visibility', href: 'overview'},
                {name: 'settings', label: 'Preferencias', icon: 'settings', href: 'settings'},
                {name: 'delete', label: 'Eliminar', icon: 'delete'}
              ]
            }
          },

          _filteredData: {
            type: Array,
            computed: '_computeFilteredData(data, _searchValue, loadComplete)'
          },

          _searchValue: {
            type: String,
            value: ''
          },

          smallScreen: {
            type: Boolean,
            observer: '_smallScreenChanged'
          },

          _overlay: {
            type: Object,
            value: null
          },

          loadComplete: Boolean

        }
      }

      connectedCallback() {
        super.connectedCallback();
        this._itemActionTapped = this._itemActionTapped.bind(this);
      }

      _computeFilteredData(data, _searchValue, loadComplete) {
        if (!loadComplete) {
          return;
        }
        var _filteredData = [];
        if (_searchValue && _searchValue && this.loadComplete) {
          _filteredData = fuzzaldrin.filter(
            data, _searchValue, {key: 'name'});
        } else {
          _filteredData = data;
        }
        return _filteredData;
      }

      _searchInputKeyup() {
        this._searchValue = this.$.searchInput.value.trim();
      }

      _smallScreenChanged(smallScreen) {
        if (this._overlay) {
          this._overlay.smallScreen = smallScreen;
        }
      }

      _openOverlay(element, properties) {
        if (this._overlay) {
          this._overlay.remove();
          this._overlay = null;
        }

        const overlay = document.createElement(element);
        //common properties
        overlay.smallScreen = this.smallScreen;
        //single properties
        for (var p in properties) {
          overlay[p] = properties[p];
        }

        overlay.addEventListener('overlay-accept-tapped', this._dialogConfirmationAccepted);

        overlay.addEventListener('overlay-closed', _ => {
          this._overlay = null;
        });

        overlay.open();
        this._overlay = overlay;
      }

      _newItemTapped() {
        this._openOverlay('rmerp-clients-new-overlay');
      }

      _menuItemTapped(event) {
        event.preventDefault();

        const dialog = this.shadowRoot.querySelector('rmerp-menu-dropdown');
        const itemIndex = event.model.__data.index;
        const item = this._filteredData[itemIndex];
        const menuIcon = event.currentTarget;

        if (dialog.opened) {
          dialog.close();
          dialog.removeEventListener('item-action-tapped', this._itemActionTapped);
          // it closes dialog and not opens again if user taps on the same menu icon of opened dialog.
          if (dialog.item.id === item.id) { return; }
        }

        dialog.addEventListener('item-action-tapped', this._itemActionTapped);

        dialog.item = item;
        dialog.hostTarget = menuIcon;
        dialog.open();
      }

      _itemActionTapped(event) {

        const action = event.detail.action;
        const item = event.detail.item;

        if (action == 'delete') {
          const overlay = this._openOverlay('rmerp-dialog-overlay', {
            text: 'Are you sure you want to delete ' + item.name + '?',
            cancelOnOutsideClick: true,
            danger: true,
            action: action,
            item: item,
            positionTarget: document.body
          });
        }

      }

      _dialogConfirmationAccepted(event) {
        
        const action = event.detail.action;
        const item = event.detail.item;

        if (action == 'delete') {
          console.log(action, " item ", item.name, item.id)
        }

      }

      _computedTotalResults(_filteredData) {
        const length = _filteredData.length || '0';
        return length + ' resultados';
      }

      _computeItemClass(index, itemsLength) {

        if (index == itemsLength - 1) {
          return 'table__item--last-child';
        }

        window.setTimeout(_ => {
          this.$.ironList.notifyResize();
        });

      }
    }

    window.customElements.define(RMERPClientsList.is, RMERPClientsList);

  </script>
</dom-module>
