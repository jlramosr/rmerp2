<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="rmerp-data.html">

<link rel="import" href="rmerp-clients-list.html">

<dom-module id="rmerp-clients">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <rmerp-data data="{{data}}" url="/clients" loading="{{loading}}"></rmerp-data>

    <app-route
        route="{{route}}"
        pattern="/:client_id/:client_page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <iron-pages selected="[[clientPage]]" attr-for-selected="name" fallback-selection="404" role="main">
      <rmerp-clients-list name="list" data="{{data}}" load-complete="[[loadComplete]]" small-screen="[[smallScreen]]" offline="[[offline]]"></rmerp-clients-list>
      <rmerp-clients-overview name="overview"></rmerp-clients-overview>
      <rmerp-clients-settings name="settings" small-screen="[[smallScreen]]" offline="[[offline]]"></rmerp-clients-settings>
      <rmerp-404-warning name="404"></rmerp-404-warning>
    </iron-pages>

  </template>

  <script>

    class RMERPClients extends Polymer.Element {

      static get is() { 
        return 'rmerp-clients'; 
      }

      static get properties() {
        return {

          clientId: {
            type: String,
            observer: '_clientIdChanged'
          },

          clientPage: {
            type: String,
            observer: '_clientPageChanged'
          }

        };
      }

      static get observers() {
        return [
          '_routeIdPageChanged(routeData.client_id, routeData.client_page)'
        ];
      }

      _routeIdPageChanged(routeDataClientId, routeDataClientPage) {
        var page;

        if (!routeDataClientId) {
          window.history.pushState({}, null, '/');
          window.dispatchEvent(new CustomEvent('location-changed'));
          page = 'list';
        }

        if (routeDataClientId !== '' && routeDataClientPage === '') {
          window.history.pushState({}, null, '/clients/' + routeDataClientId + '/overview/');
          window.dispatchEvent(new CustomEvent('location-changed'));
          page = 'overview';
        }

        this.clientId = routeDataClientId || null;
        this.clientPage = routeDataClientPage || page;

      }

       _clientIdChanged(id) {
        console.log("_clientIdChanged", id);
       }

      _clientPageChanged(page) {
        console.log("_clientPageChanged", page);
        var href;

        if (page === '404-warning') {
          href = this.resolveUrl('rmerp-' + page + '.html');
        } else {
          href = this.resolveUrl('rmerp-clients-' + page + '.html');
        }
        Polymer.importHref(href, null, null, true);
      }


    }

    window.customElements.define(RMERPClients.is, RMERPClients);

  </script>
</dom-module>
