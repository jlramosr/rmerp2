<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="rmerp-styles.html">
<link rel="import" href="rmerp-common.html">
<link rel="import" href="rmerp-tmpl-form-item.html">

<dom-module id="rmerp-tmpl-form">
  <template>

    <style include="show-styles">
      :host {
        height: 100vh;
        padding: 0;
        display: grid;
        grid-auto-flow: row;
        grid-template-columns: repeat(var(--columns), auto);
        grid-template-rows: repeat(auto-fill, 60px);
        grid-gap: 0px 0px;
        justify-content: stretch;
        align-items: stretch;
      }

      .form-item__container {
        position: relative;
      }

      .form-item__icon {
        position: absolute;
        top: 28px;
        left: 0;
        color: var(--rmerp-primary-color);
        opacity: 0.6;
      }

      .icon--without-label {
        top: 7px;
      }

      .form-item__item {
        outline: none;
        --paper-input-container-color: var(--rmerp-primary-dark-color);
        --paper-input-container-input-color: var(--rmerp-primary-dark-color);
        --paper-input-container-focus-color: var(--rmerp-secondary-color);
        --paper-input-container-input: {
          font-size: 14px;
        }
        --paper-input-container-label: {
          font-size: 16px;
        }
        --paper-input-container-disabled: {
          opacity: 0.66;
          color: var(--rmerp-primary-soft-color);
        }
        --paper-input-container-underline-disabled: {
          background: var(--rmerp-primary-soft-color);
          border: 1px solid var(--rmerp-primary-soft-color);
        }
      }

      :host(:not([edit-mode])) .form-item__item {
        --paper-input-container-disabled: {
          opacity: 1;
          color: var(--rmerp-primary-soft-color);
        }
        --paper-input-container-underline-disabled: {
          background: var(--rmerp-primary-soft-color);
          border: 1px solid var(--rmerp-primary-soft-color);
          opacity: 0.15;
        } 
      }

      :host(:not([edit-mode])) .form-item__icon {
        opacity: 1;
      }

      .item--with-icon {
        --paper-input-container-input: {
          padding-left: 14px;
        }
      }

      .item--input {
      }

      .item--textarea {
        @apply --layout-fit;
      }

      .item--tabs {
        @apply --layout-vertical;
        height: 100%;
        box-shadow: 0 4px 6px 1px rgba(0, 0, 0, 0.14),
                    0 2px 4px 1px rgba(0, 0, 0, 0.12),
                    0 3px 2px -1px rgba(0, 0, 0, 0.1);
      }

      .tabs__tabs {
        --paper-tabs-selection-bar-color: var(--rmerp-secondary-color);
        --paper-tabs-content: {
          background: var(--rmerp-primary-light-color);
        }
      }

      .tabs__pages {
        @apply --layout-flex;
        overflow: auto;
      }

      .tabs__tab {
      }

      .pages__form {
        padding: 0 8px;
        height: 100%;
      }
    </style>

    <template is="dom-repeat" items="{{_fields}}" as="field">

      <rmerp-tmpl-form-item
        rows="[[_getViewProperty(editMode, field.showView.rows, field.editView.rows)]]"
        row-start="[[_getViewProperty(editMode, field.showView.rowStart, field.editView.rowStart)]]"
        row-end="[[_getViewProperty(editMode, field.showView.rowEnd, field.editView.rowEnd)]]"
        cols="[[_getViewProperty(editMode, field.showView.cols, field.editView.cols)]]"
        col-start="[[_getViewProperty(editMode, field.showView.colStart, field.editView.colStart)]]"
        col-end="[[_getViewProperty(editMode, field.showView.colEnd, field.editView.colEnd)]]"
        small-cols="[[_getViewProperty(editMode, field.showView.smallCols, field.editView.smallCols)]]"
        small-col-start="[[_getViewProperty(editMode, field.showView.smallColStart, field.editView.smallColStart)]]"
        small-col-end="[[_getViewProperty(editMode, field.showView.smallColEnd, field.editView.smallColEnd)]]"
        small-screen="[[smallScreen]]"
        form-cols="[[columns]]"
        hidden$="[[_computeHideItem(editMode, field.editView, field.showView)]]">

        <template is="dom-if" if="[[_isInput(field.type)]]">
          
          <div class="form-item__container">
            <paper-input
              always-float-label
              no-label-float$="[[_computeHideLabel(field.editView)]]"
              class$="form-item__item item--input [[_computeClassInputWithIcon(field.icon, field.editView)]]"
              required="[[field.required]]"
              disabled="[[_computeDisabledInput(field.readOnly, editMode)]]"
              label="[[field.label]]"
              value="{{_getValue(data, field.name)}}"></paper-input>
            <iron-icon
              icon$="rmerp-icons:[[field.icon]]"
              class$="form-item__icon [[_computeClassIcon(field.editView)]]"
              hidden$="[[_computeHideIcon(field.icon, field.editView)]]"></iron-icon>
          </div>

        </template>

        <template is="dom-if" if="[[_isSelect(field.type)]]">
          <paper-input
            always-float-label
            class="form-item__item item--input"
            required="[[field.required]]"
            disabled="[[field.readOnly]]"
            label="[[field.label]]"
            value="{{_getValue(data, field.name)}}"></paper-input>
        </template>

        <template is="dom-if" if="[[_isText(field.type)]]">
          <div class="form-item__container">
            <paper-textarea always-float-label
              class="form-item__item item--textarea"
              rows="[[field.editView.rows]]"
              max-rows="[[field.editView.rows]]"
              required="[[field.required]]"
              disabled="[[field.readOnly]]"
              label="[[field.label]]"
              value="{{_getValue(data, field.name)}}"></paper-textarea>
          </div>
        </template>

        <template is="dom-if" if="[[_isTab(field.type)]]">
          <div class="form-item__item item--tabs">
                      <div class="form-item__container">
            <paper-tabs selected="{{tabSelected}}" id="paperTabs" class="tabs__tabs">
              <template is="dom-repeat" items="{{field.tabs}}" as="tab">
                <paper-tab class="tabs__tab">[[tab.label]]</paper-tab>
              </template>
            </paper-tabs>
            </div>

            <iron-pages selected="{{tabSelected}}" class="tabs__pages">
              <template is="dom-repeat" items="{{field.tabs}}" as="tab">

                <rmerp-tmpl-form
                  class="pages__form"
                  edit-mode="[[editMode"]]
                  data="[[data]]"
                  model="[[tab.items]]"
                  columns="[[columns]]"
                  small-screen="[[smallScreen]]"
                  medium-screen="[[mediumScreen]]"></rmerp-tmpl-form>

              </template>
            </iron-pages>
          </div>
        </template>

      </rmerp-tmpl-form-item>

    </template>

  </template>

  <script>

    class RMERPTmplForm extends Polymer.Element {

      static get is() { return 'rmerp-tmpl-form'; }

      static get properties() {
        return {

          data: Object,

          model: Array,

          _fields: {
            type: Array,
            computed: '_computeFields(model)'
          },

          tabSelected: {
            type: Number,
            value: 0
          },

          editMode: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },

          smallScreen: Boolean,

          mediumScreen: Boolean,

          columns: Number,

          maxColumns: {
            type: Number,
            value: 1000,
            readOnly: true
          }
        
        }

      }

      connectedCallback() {
        super.connectedCallback();

        if (!this.columns || this.columns < 1 || this.columns > this.maxColumns) {
          this.columns = 10;
        }

        this.updateStyles({
          '--columns': this.columns
        });

      }

      _computeFields(model) {
        let _fields = RMERPCommon.cloneObject(model);
        //https://gist.github.com/chad3814/2924672.
        for (let itemIndex = _fields.length - 1; itemIndex >= 0; itemIndex -= 1) {
          let itemModel = _fields[itemIndex];
          const itemTabName = itemModel.editView.tab;
          if (itemTabName) { 

            //item goes within a tab.
            _fields.forEach(itemModelSearch => {

              if (itemModelSearch.type == 'tab') {
                //one tab container founded.
                const tabContainer = itemModelSearch;
                tabContainer.tabs.forEach(tab => {

                  if (tab.name == itemTabName) {
                    //the tab container founded corresponds with the item tab.
                    if (!tab.items) {
                      tab.items = [];
                    }
                    tab.items.push(itemModel);
                    _fields.splice(itemIndex, 1);
                  }

                });
              } 
            }); 
          }
        }
        return _fields;
      }

      _getValue(data, field){
        if (!data) return '';
        return data[field];
      }

      _computeHideIcon(icon, editView) {
        return !icon || editView.showIcon === false;
      }

      _computeClassInputWithIcon(icon, editView) {
        return (icon && editView.showIcon !== false) ? 'item--with-icon' : '';
      }

      _computeClassIcon(editView) {
        return editView.showLabel === false ? 'icon--without-label' : '';
      }

      _computeHideLabel(editView) {
        return editView.showLabel === false;
      }

      _computeDisabledInput(fieldReadOnly, editMode) {
        return fieldReadOnly || !editMode;
      }

      _computeHideItem(editMode, fieldEditView, fieldShowView) {
        return (!fieldEditView && !fieldShowView) || 
               (editMode && !fieldEditView) || 
               (!editMode && !fieldShowView)
      }

      _getViewProperty(editMode, showModeProperty, editModeProperty) {
        return !editMode ? showModeProperty : editModeProperty;
      }

      _isInput(type) { return type === 'string' || type === 'number'; }
      _isText(type) { return type === 'text'; }
      _isSelect(type) { return type === 'select'; }
      _isTab(type) { return type === 'tab'; }

    }

    window.customElements.define(RMERPTmplForm.is, RMERPTmplForm);

  </script>
</dom-module>
