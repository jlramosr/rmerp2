<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="rmerp-common.html">
<link rel="import" href="rmerp-backend-connection.html">

<link rel="import" href="rmerp-app.html">

<dom-module id="rmerp-core">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="[[route]]"></app-route>

    <iron-media-query query="max-width: 640px" query-matches="{{smallScreen}}"></iron-media-query>
    <iron-media-query query="max-width: 1084px" query-matches="{{mediumScreen}}"></iron-media-query>

    <rmerp-backend-connection
      id="backendConnection"
      user="{{user}}"
      user-status-known="{{userStatusKnown}}"></rmerp-backend-connection>

  </template>

  <script>
    class RMERPCore extends Polymer.Element {

      static get is() { return 'rmerp-core'; }

      static get properties() {
        return {

          _currentElement: Object,

          account: Object,

          user: Object,

          userStatusKnown: Boolean,

          route: {
            type: Object,
            observer: '_routeChanged'
          },

          smallScreen: {
            type: Boolean,
            observer: '_smallScreenChanged'
          },

          mediumScreen: {
            type: Boolean,
            observer: '_mediumScreenChanged'
          },

          loadComplete: Boolean

        };
      }

      static get observers() {
        return [
          '_userStatusKnownChanged(user, userStatusKnown)'
        ];
      }

      _appendElement(page) {
        if (this._currentElement) {
          this._currentElement.remove();
          this._currentElement = null;
        }

        var currentElement = document.createElement('rmerp-' + page);
        
        // common properties.
        currentElement.route = this.route;
        currentElement.smallScreen = this.smallScreen;
        currentElement.mediumScreen = this.mediumScreen;

        this.shadowRoot.appendChild(currentElement);
        this._currentElement = currentElement;

        const href = this.resolveUrl('rmerp-' + page + '.html');
        Polymer.importHref(href, null, null, true);

        // common listeners
        this._currentElement.addEventListener('element-rendered', event => {
          console.log("HOLA");
          this._ensureLazyLoaded();
        });

      }

      _appendAppElement() {
        this._appendElement('app');

        // local properties.
        this._currentElement.defaultCategory = 'clients';

        // local listeners.
        this._currentElement.addEventListener('logout-tapped', event => {
          this.$.backendConnection.logout().
            then(response => {
              RMERPCommon.updateWindowLocation('/account');
              console.log("LOGOUT CORRECTO uid=", response.uid);
            });
        });
      }

      _appendGuessElement() {
        this._appendElement('account')

        // local properties.

        // local listeners.
        this._currentElement.addEventListener('login-tapped', event => {
          var account = event.detail.account;
          this.$.backendConnection.login(account.email, account.password).
            then(response => {
              RMERPCommon.updateWindowLocation('/');
              console.log("LOGIN CORRECTO uid=", response.uid);
            });
        });
      }

      _appendErrorElement() {
        this._appendElement('404-warning');
      }

      _userStatusKnownChanged(user, userStatusKnown) {
        if (!userStatusKnown) { return; }  

        // app page load if there is user log in
        if (user) {
          this._appendAppElement();
          return;
        }

        var path = this.route.path.split('/');
        var mainPage = path[1];
        var restPath = path[2];

        // error page load.
        if (mainPage !== '' && mainPage !== 'account') {
          this._appendErrorElement();
          return;
        }

        // redirect to login if there is no main page or there is long account route.
        if ((restPath && mainPage === 'account') || mainPage === '') {
          RMERPCommon.updateWindowLocation('/account');
        }

        // guess page load.
        this._appendGuessElement();  

      }

      _routeChanged(route) {
        // databinding.
        if (this._currentElement) {
          this._currentElement.route = route;
        }
      }

      _smallScreenChanged(smallScreen) {
        // databinding.
        if (this._currentElement) {
          this._currentElement.smallScreen = smallScreen;
        }
      }

      _mediumScreenChanged(mediumScreen) {
        // databinding.
        if (this._currentElement) {
          this._currentElement.mediumScreen = mediumScreen;
        }
      }

      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, _ => {
            console.log("HOLAAAA core");
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), _ => {
              this.loadComplete = true;
              // Load pre-caching Service Worker
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
            });

          });
        }
      }

    }

    window.customElements.define(RMERPCore.is, RMERPCore);

  </script>
</dom-module>
